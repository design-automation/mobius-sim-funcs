## FLOWCHART  
  
The _Flowchart_ pane is for creating the flowchart for your script.

A Mobius script consists of a flowchart of nodes. Each node contains a procedure that performs some kind of action, usually creating, deleting, or modifying geometric entities in the model. The nodes are connected by links, representing the flow of the model data between nodes.

A flowchart has a `Start` node and an `End` node. Between these two nodes, you can create multiple other nodes, connected with links. By default, when you create a new flowchart, one additional node gets generated, linked to the `Start` and `End` nodes.

Here is an example of a flowchart with five nodes, labelled `A`, to `E`. 

![Example flowchart with five nodes](assets/typedoc-json/docUI/imgs/flowchart_example.png)

**Executing Scripts**

A Mobius script is executed by clicking the 'Play' button in the top toolbar. Executing the script will execute the procedures in each of the nodes in the flowchart, one by one.

Looking at the example flowchart above, when the script is executed, the following happens:
1. The procedure in the `Start` node is executed, and a model is generated.
1. The procedure in node `A` is executed, with the model from the `Start` node as the input.
1. The procedure in node `B` is executed, with the model from node `A` as the input.
1. The procedure in node `C` is executed, with the model from node `A` as the input.
1. The procedure in node `D` is executed, with the model from node `A` as the input.
1. The procedure in node `E` is executed, with the merged model from nodes `B`, `C`, and `D` as input.

Note how models are being copied and merged when the flowchart gets executed:
* Node `A` has three output links, connecting to three downstream nodes, `B` , `C` and `D`. The model that is generated by `A` is copied three times, so that nodes `B` , `C` and `D` all receive the same model.
* Node `E` has three input links, connecting to three upstream nodes, `B` , `C` and `D`. The models generated by these three nodes are automatically merged in order to create the input for node `E`.

Note also that for steps 3, 4 and 5, the order of execution makes no difference. The actual order will depend on the order in which you create the links between the nodes. 

The order of execution can be verified from the node dropdown menu, as follows:

![Execution order](assets/typedoc-json/docUI/imgs/flowchart_node_order.png)

By default, the Mobius settings are set to automatically execute a script when it is first loaded. In some cases, this may not be desirable, either because your script is slow to execute or because you script has an error that crashes the browser (for example, an infinite loop). In such cases, you can change the default settings in the Mobius Menu > Settings.

**Saving Scripts**

A Mobius script can be saved as a `.mob` file. This file contains all parts of the script, including the dashboard, the flowchart, the procedures in each of the nodes, and the viewer settings. The Mobius Menu in the top bar can be used for loading and saving script files.

![Mobius Menu](assets/typedoc-json/docUI/imgs/menu2.png)

By default, when you open Mobius a new script file is loaded. 
* _New File_: Creates a new `.mob` file with a default flowchart.

Script files can be loaded from and saved to your local drive:
* _Load File_: Loads an existing `.mob` file from your local drive.
* _Save File_: Saves a `.mob` file to your local drive.

Script files can also be loaded from and saved to Local Storage. Local storage saves the data locally within your browser. Note that if you clear your browser's cache, it will delete all the files saved in Local Storage. 
* _Local Storage_: Saves the `.mob` file to Local Storage.

Every time you execute a script, it is also automatically saved to Local Storage, using the name set in the start node. This is a backup that allows you to recover the file if the Mobius browser web pages closes unexpectedly or crashes and you have forgotten to save your file.

If no script name is set, then the file will be saved with the name `Untitled.mob` in Local Storage. (Note that if you have multiple un-named scripts, then they will overwrite each other.) Below is an example of setting the script name in the start node to `My Script Name`. In this case, the file would be saved with the name `My_Script_Name.mob`.

![Setting script name in Start node](assets/typedoc-json/docUI/imgs/flowchart_script_name.png)

The saved file can be retrieved by selecting _Local Storage_ in the Mobius Menu. Below is the dialog box that opens up:

![Retrieving file from Local Storage](assets/typedoc-json/docUI/imgs/flowchart_local_storage.png)

**Node Styles**

The nodes in the flowchart are styled differently, depending on a number of factors. The flowchart below shows the different node styles.

![Node styles](assets/typedoc-json/docUI/imgs/flowchart_node_styles.png)

Starting from the left, the nodes are as follows:
* A normal node, with both input links and output links, and no errors.
* A selected node with both input links and output links.
* A node with an input link, but no output links. Even though there is no output link, the node will still be executed and a model will get generated.
* A node with an output link, but no input links. The node will not be executed.
* A node with a procedure that generated an error when it was executed.

**Editing Flowcharts**

The basic editing operations are as follows:
* To select a node, left-click on the node. To select multiple nodes, left-click while pressing the Ctrl key.
* To create a node, double-click anywhere on the canvas.
* To delete a node, select the node and press the 'Delete` key.
* To create a link between two nodes, hover over the edge of the source node, left-click press down, drag to the target node, and then release the left-click up.
* To delete a link between two nodes, select the link and press the 'Delete` key.
* To move a node, select the node and drag.
* To rename a node, click once on the node to select it, and then click a second time to enter 'edit' mode.
* To enter a node and see the procedure inside it, double click ob the node.

**Cut, Copy, Paste, Undo**

Nodes can be cut, copied, and pasted by selecting them and using the usual keyboard shortcuts. 
* Cut: Ctrl-x on Windows (⌘-x on Macs)
* Copy: Ctrl-c on Windows (⌘-c on Macs)
* Paste: Ctrl-v on Windows (⌘-v on Macs)

When pasting a node, the position of the node will be centered on the location where the mouse is hovering.

The cut/copy/paste operations can be undone using the undo keyboard command:
* Undo: Ctrl-z on Windows (⌘-z on Macs)

Note that undo only applies to creating and deleting node and links, and with cut/copy/paste operations. It will not work for other flowchart operations such as moving and renaming nodes. 

**Viewing Models**

After executing the flowchart, the output model generated by each node is saved. Selecting the node will display the model in the viewer on the right. If more than one node is selected, then the model in the last selected node will be displayed.

In some cases, nodes will not have any output model:
* Nodes with no input links are not executed.
* Nodes with errors are executed, but due to the error execution will stop.
* Nodes that are downstream of nodes with no input links or nodes with errors are not executed. 

The flowchart below shows an example where only the first node is executed, so only the first node will have a model output. The other four nodes will all have no model output. As a result, clicking these nodes will not show anything in the viewer on the right. 

![Example flowchart with nodes that are not executed](assets/typedoc-json/docUI/imgs/flowchart_no_model.png)

**Start and End Nodes**

The `Start` and `End` nodes are different from the other nodes.

`Start` node:
* When a Mobius script is executed, a new empty model is first initialized in the `Start` node.  The procedure in the `Start` node will then be executed. 
* The script name, script description, and script parameters are defined in the `Start` node.
* When importing a Mobius script as a _global functions_, the procedure in the `Start` node is not executed. This is discussed in more detail in the section on [Global Functions].

`End` node:
* When a Mobius script is executed, execution will end with the procedure in the `End` node.
* When importing a Mobius script as a _global functions_, the return value of the global function can be specified in the `Return` input box in the `End` node. This is discussed in more detail in the help section on [Global Functions].

`Start` and `End` cannot be renamed or deleted.

**Immutable Object Topology**

The procedure in each node can modify the input model. 

The objects in the input model consist of points, polylines, and polygons. These objects all have an internal topological structure. For points, the topology is very simple; a point just has a single vertex. For polylines and polygons, the topology can be more complex, consisting of vertices, edges, and wires.

The modelling functions includes a category called `edit`, which includes functions such as `edit.Divide` (which divides edges) and `edit.Hole` (which makes holes in polygons). These functions all change the topology of objects, by modifying the internal structure of vertices, edges, or wires.

Within one node, the topology of an object can be modified and edited. For example, you can create a polygon, then make a hole in the polygon, and then divide its edges. As long as these operations are all performed in the same node, there will be no issue.

However, the topology of objects coming in from an input model are immutable and cannot be edited. Trying to edit the topology of such objects will result in an error. 

Here is an example of a flowchart that first creates a polygon in one node, and then tries to edit that polygon in a downstream node, by divide the polygon edges. This results in an error.

![Editing immutable topology error](assets/typedoc-json/docUI/imgs/flowchart_immutable_error.png)

In such cases, there is a straightforward solution, which is to clone the object before editing it. The `make.Clone` function will make a copy of the polygon (and delete the old polygon). The topology of the copied polygon can then be edited.

Note that although object topology is immutable, object attributes are not immutable. This means that for any incoming objects, the attributes of those objects can all be changed without any issue. For example, by modifying the XYZ attributes of the positions, you can change change the location, orientation, and shape of a polygon with affecting its topology.

**Merging Models**

When a node has multiple inputs, the the models are merged. We refer to the multiple input models as _input models_, and to the model that is creating by merging these input models as the _merged model_. The merging process is performed automatically. The procedure in the node does not have access to the input models prior to merging. It only has access to the merged model.

The process of merging models follows certain simple rules, described below. 

_Merging Objects_

Objects in the merged model are the union of the sets of objects in the input models. For example, consider the following example where three collections get merged into one collection:

* Polylines in input model 0: `'pl1', 'pl2'`
* Polylines in input model 1: `'pg2', 'pg3'`
* Polylines in input model 2: `'pg3', 'pg4'`
* Polylines in merged model: `'pg1', 'pg2', 'pg3', 'pg4'`

_Merging Collections_

Collections in the merged model are the union of the collections in the input models. In addition, for each collection, the contents of the collection is the union of the objects in each collection. 

For example, consider the following example where three collections get merged into one collection:

* `collA` in input model 0: `'pg1', 'pg2', 'pg3'`
* `collA` in input model 1: `'pg1', 'pg2', 'pg3', 'pg4'`
* `collA` in input model 2 has been deleted
* `collA` in merged model: `'pg1', 'pg2', 'pg3', 'pg4'`

_Merging Attributes_

Attributes in the merged model are the union of the attributes in the input models. For each geometric entity, the attributes data in the merged model is created by merging all the attributes for that same entity in the input models.  

For example, consider the following three polygons being merged:

* `'pg0'` in input model 0 has attributes: `att_a: 123, att_b: "xxx"`
* `'pg0'` in input model 1 has attributes: `att_a: 123, att_c: [4,5,6]`
* `'pg0'` in input model 1 has attributes: `att_d: 0.1`
* `'pg0'` in merged model has attributes: `att_a: 123, att_b: "xxx", att_c: [4,5,6], att_d: 0.1`

_Attribute Merge Conflicts_

When merging, if entities have the same attribute but with different values, then this will result in an _attribute merge conflict_ error being thrown.

Consider the following example. A polygon is created in the first node. The two downstream nodes then each create an attribute call `att_a`, but they assign different values to this attribute. As a result, an error is thrown in the `End` node, when the two models get merged.

![Attribute conflict error for polygons](assets/typedoc-json/docUI/imgs/flowchart_attrib_merge_conflict.png)

Merging models in the `End` node: 
* `'pg0'` in input model 0 has attribute: `att_a: 123`
* `'pg0'` in input model 1 has attribute: `att_a: 456`
* ERROR: Attribute Merge Conflict

This type of error is usually a careless mistake. You ust need to decide which attribute value is the correct one.

Another common example of a merge conflict is when `xyz` attributes of a set of positions get changed, due to an object being transformed in some way. In the example below, a polygon is created in the first node, and the polygon is then later moved (up in the z direction by 8 units).

![Attribute conflict error for positions](assets/typedoc-json/docUI/imgs/flowchart_attrib_merge_conflict_xyz.png)

Merging models in the `End` node: 
* `'ps0'` in input model 0 has attribute:  `xyz: [0,0,0]`
* `'ps0'` in input model 1 has attribute:  `xyz: [0,0,8]`
* ERROR: Attribute Merge Conflict

For this type of error, the solution is usually to clone the object before transforming it, using the `make.Clone` function. The process of cloning will give the new polygon a different ID. When the polygons are merged in the `End` node, they will have different IDs and as a result there will be no merge conflict. 